<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>★★★ THE SLOPULATOR ★★★ - COMP ME DADDY LIVE</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <script src="app.js"></script>
    <style>
        body { background: #000; color: #0f0; font-family: 'Comic Sans MS', cursive; }
        .retro-input { background: #111; border: 2px solid #0f0; color: #0f0; padding: 8px; }
        .suggestions { position: absolute; background: #111; border: 1px solid #0f0; max-height: 200px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #030; }
        .suggestion-item:hover { background: #222; }
    </style>
</head>
<body>
    <center>
        <h1>★★★ THE SLOPULATOR ★★★</h1>
        <h2>COMP ME DADDY - LIVE</h2>
        
        <div class="search-container" style="position:relative;display:inline-block;">
            <input type="text" id="addressInput" class="retro-input" 
                   placeholder="Enter address..." size="50"
                   oninput="handleAddressInput(this.value)">
            <div id="addressSuggestions" class="suggestions"></div>
        </div>
        
        <br><br>
        
        <div id="results" style="display:none;">
            <h3>Property Data (from PropertyReach)</h3>
            <table border="1" style="border:2px solid #0f0;">
                <tr><td>Estimated Value:</td><td><input type="text" id="zestimate" class="retro-input" readonly></td></tr>
                <tr><td>Square Feet:</td><td><input type="text" id="sqft" class="retro-input" readonly></td></tr>
                <tr><td>Bedrooms:</td><td><input type="text" id="bedrooms" class="retro-input" readonly></td></tr>
                <tr><td>Bathrooms:</td><td><input type="text" id="bathrooms" class="retro-input" readonly></td></tr>
                <tr><td>Year Built:</td><td><input type="text" id="yearBuilt" class="retro-input" readonly></td></tr>
                <tr><td>Monthly Taxes:</td><td><input type="text" id="monthlyTaxes" class="retro-input" readonly></td></tr>
                <tr><td>Last Sale:</td><td><input type="text" id="lastSalePrice" class="retro-input" readonly></td></tr>
            </table>
        </div>
        
        <div id="error" style="color:red;display:none;">
            <p>Error loading property data. Please try again.</p>
        </div>
    </center>

    <script>
        const PROXY_URL = 'https://srv1336418.hstgr.cloud/?url=';
        const API_KEY = 'live_u9JyD3Hmp58wmEQEnyZ5GosDjDcXHH5SuUN';
        
        let autocompleteTimeout;
        
        // Address autocomplete using Nominatim
        function handleAddressInput(value) {
            clearTimeout(autocompleteTimeout);
            const el = document.getElementById('addressSuggestions');
            if (value.length < 3) { el.style.display = 'none'; return; }
            
            autocompleteTimeout = setTimeout(async () => {
                try {
                    const resp = await fetch('https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(value) + '&format=json&limit=5', {
                        headers: {'User-Agent': 'Slopulator/1.0'}
                    });
                    const data = await resp.json();
                    if (data.length > 0) {
                        el.innerHTML = data.map(p => 
                            '<div class="suggestion-item" onclick="selectAddress(\'' + p.display_name.replace(/'/g, "\\'") + '\')">' + p.display_name + '</div>'
                        ).join('');
                        el.style.display = 'block';
                    } else {
                        el.style.display = 'none';
                    }
                } catch(e) {
                    console.error(e);
                    el.style.display = 'none';
                }
            }, 300);
        }
        
        function selectAddress(addr) {
            document.getElementById('addressInput').value = addr;
            document.getElementById('addressSuggestions').style.display = 'none';
            loadPropertyData(addr);
        }
        
        // Load property data from PropertyReach via proxy
        async function loadPropertyData(address) {
            const results = document.getElementById('results');
            const error = document.getElementById('error');
            results.style.display = 'none';
            error.style.display = 'none';
            
            try {
                // Parse address
                const parts = address.split(',').map(s => s.trim());
                let streetAddress = parts[0] || '';
                let city = parts[1] || '';
                let state = parts[2]?.split(' ')[0] || '';
                if (parts.length > 3) {
                    city = parts[2] || '';
                    state = parts[3] || '';
                }
                
                console.log('Loading:', streetAddress, city, state);
                
                // Call PropertyReach via proxy
                const url = PROXY_URL + encodeURIComponent('https://api.propertyreach.com/v1/search');
                const body = {
                    target: { streetAddress, city, state },
                    filter: {},
                    limit: 1
                };
                
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY
                    },
                    body: JSON.stringify(body)
                });
                
                if (!resp.ok) throw new Error('API error: ' + resp.status);
                
                const data = await resp.json();
                console.log('PropertyReach response:', data);
                
                if (!data.properties || data.properties.length === 0) {
                    throw new Error('No property found');
                }
                
                const prop = data.properties[0];
                
                // Populate fields
                document.getElementById('zestimate').value = prop.estimatedValue ? '$' + prop.estimatedValue.toLocaleString() : '';
                document.getElementById('sqft').value = prop.squareFeet || prop.livingSquareFeet || '';
                document.getElementById('bedrooms').value = prop.bedrooms || '';
                document.getElementById('bathrooms').value = prop.bathrooms || '';
                document.getElementById('yearBuilt').value = prop.yearBuilt || '';
                document.getElementById('monthlyTaxes').value = prop.taxAmount ? '$' + Math.round(prop.taxAmount/12).toLocaleString() : '';
                document.getElementById('lastSalePrice').value = prop.lastSaleAmount ? '$' + prop.lastSaleAmount.toLocaleString() : '';
                
                results.style.display = 'block';
                
            } catch(e) {
                console.error(e);
                error.style.display = 'block';
            }
        }
    </script>
</body>
</html>
